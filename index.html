<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Creami ‚Äì Ninja Creami Recipe Generator</title>

  <!-- iPhone full‚Äëscreen web app setup -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Creami" />
  <meta name="theme-color" content="#0f1220" />
  <!-- Inline touch icon (works for Add to Home Screen) -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAB2Qf1cAAAACXBIWXMAAAsSAAALEgHS3X78AAABlUlEQVR4nO3QwQ3CMBQF0e9Zp5cQb0b8y7R4kXgBqgYWq8y0gHq3dK0C0Jx9bG6o/2+gC2zQF6vRjv8yOYCQAAAAAAAAAAAAAAAAAAAHx2n8KXv1q4lC6bW3tS0j+8yq3u6v8w3X4p1k2s3n2Zc7r1lX7+7n2y3s5n0z7H1t0v7r3a9b8m0v5p7b9a8n0z6r7b8m0v5p7b9a8n0z6r7b8m0v5p7b9a8n0z6r7b8m0v5p7b9a8n0z6r7b8m0v5p7b9a8n0z6r7Yq4x3l4f3v1+f9Jf2vC8+3m8f9v3fP8v1f4f9v3fP8v1f4f9v3fP9b3Zq3Y3m5r3bP1p2w7m6b3bP1p2w7m6b3bP1p2w7m6b3bP1p2w7m6b3bP1p2w7m6Z4fX8fL7f/6d4AAAAAAAAAAAAAAAAAAAAAAJ7mB2yQx1S7YtM4AAAAAElFTkSuQmCC" />

  <style>
    :root{ --bg:#0f1220; --panel:#171a2b; --muted:#8b90a6; --text:#f4f6ff; --brand:#6ae4a6; --accent:#75a7ff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:linear-gradient(180deg,#0b0e1a,#13162a 40%,#0b0e1a); color:var(--text) }
    header{ position:sticky; top:0; backdrop-filter:blur(6px); background:rgba(10,12,24,.6); border-bottom:1px solid #22273f; z-index:50; padding-top: env(safe-area-inset-top) }
    .wrap{ max-width:1050px; margin:0 auto; padding:18px }
    h1{ font-size:clamp(20px,3.8vw,32px); margin:0 0 6px 0; letter-spacing:.2px }
    .sub{ color:var(--muted); font-size:14px }
    main{ max-width:1050px; margin:22px auto; display:grid; grid-template-columns:1.1fr .9fr; gap:18px; padding:0 18px }
    @media (max-width:900px){ main{ grid-template-columns:1fr; }}
    .card{ background:var(--panel); border:1px solid #22273f; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden }
    .card h2{ font-size:18px; margin:0; padding:14px 16px; border-bottom:1px solid #22273f; background:linear-gradient(180deg,#1a1d31,#171a2b) }
    .card .body{ padding:14px 16px }
    label{ display:block; font-size:13px; color:var(--muted); margin:10px 0 6px }
    input[type="text"],input[type="number"],textarea{ width:100%; background:#0f1220; color:var(--text); border:1px solid #252a42; border-radius:10px; padding:10px 12px; outline:0 }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{ background:#101329; border:1px solid #252a42; color:#cbd3ff; padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer }
    .chip.active{ outline:2px solid var(--brand); color:#0e2019; background:#bff5da }
    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    button{ cursor:pointer; border:1px solid #2a2f4a; background:#0e1024; color:#e8edff; border-radius:12px; padding:10px 14px; font-weight:600 }
    button.primary{ background:linear-gradient(180deg,#67f0ba,#4ed2ff); color:#0a1220; border:0 }
    button.ghost{ background:transparent; border-color:#2a2f4a }
    button.warn{ background:#2a0e12; border-color:#7a1d25; color:#ffb0b0 }
    .recipe{ white-space:pre-wrap; line-height:1.45 }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .badge{ display:inline-grid; place-items:center; padding:2px 8px; border-radius:8px; border:1px solid #2a2f4a; color:#c9d1ff; font-size:12px }
    .muted{ color:var(--muted) }
    .fav{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center }
    .rowlist{ display:grid; gap:8px }
    .small{ font-size:12px }
    .code{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12.5px; background:#0c0f1d; padding:10px; border-radius:10px; border:1px solid #22273f; color:#b7c1ff }
    .footer{ max-width:1050px; margin:12px auto 26px; padding:0 18px; color:#8b90a6; font-size:12px }
    .switch{ display:flex; align-items:center; gap:10px }
    .switch input{ accent-color:#5af0b9 }

    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; place-items:center; padding:18px; z-index:120 }
    .modal .panel{ width:min(900px,100%); background:var(--panel); border:1px solid #263053; border-radius:16px; box-shadow:0 30px 60px rgba(0,0,0,.5); overflow:hidden }
    .panel header{ position:unset; backdrop-filter:none; background:linear-gradient(180deg,#1a1d31,#171a2b); border-bottom:1px solid #22273f }
    .panel .body{ padding:14px 16px }
    .panel footer{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid #22273f }
    textarea.json{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; min-height:280px; resize:vertical }

    /* Install tip banner (only when not standalone) */
    #installTip{ position:fixed; left:12px; right:12px; bottom:12px; z-index:99; background:#0f1328; border:1px solid #25305c; border-radius:14px; padding:12px; display:none; box-shadow:0 10px 26px rgba(0,0,0,.4) }
    #installTip .row{ grid-template-columns:1fr auto }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Ninja Creami Recipe Generator</h1>
      <div class="sub">Randomly invents unique, great‚Äëtasting, lower‚Äëcalorie flavors with your pantry. Save favorites, tweak, and re‚Äëroll parts. iPhone‚Äëready ‚úÖ</div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Generator Settings</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Base style</label>
            <div class="chips" id="baseChips"></div>
          </div>
          <div>
            <label>Flavor theme</label>
            <div class="chips" id="themeChips"></div>
          </div>
        </div>

        <div class="row">
          <div class="switch">
            <input type="checkbox" id="milkOnly" />
            <label for="milkOnly">Milk‚Äëonly base (no yogurt, no protein)</label>
          </div>
          <div class="switch">
            <input type="checkbox" id="excludeCake" checked />
            <label for="excludeCake">Exclude cake‚Äëbatter flavors</label>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Sweetness (monk fruit)</label>
            <input type="range" id="sweetSlider" min="0" max="6" value="3" />
          </div>
          <div>
            <label>Intensity (extracts/powders)</label>
            <input type="range" id="intenseSlider" min="1" max="5" value="3" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Max mix‚Äëins</label>
            <input type="number" id="mixMax" value="2" min="0" max="4" />
          </div>
          <div>
            <label>Max swirls</label>
            <input type="number" id="swirlMax" value="1" min="0" max="2" />
          </div>
          <div>
            <label>Random seed (optional)</label>
            <input type="text" id="seed" placeholder="leave blank for chaos" />
          </div>
        </div>

        <div class="btnbar">
          <button class="primary" id="btnGenerate">üé≤ Generate Recipe</button>
          <button class="ghost" id="btnRerollMix">‚Üª Reroll mix‚Äëins</button>
          <button class="ghost" id="btnRerollFlavor">‚Üª Reroll flavor notes</button>
          <button class="ghost" id="btnCopy">üìã Copy</button>
          <button class="ghost" id="btnPantry">üõ†Ô∏è Edit pantry</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Recipe</h2>
      <div class="body">
        <div id="titleRow" class="grid">
          <div class="badge" id="calories">~0 kcal / pint</div>
          <div class="badge" id="themeBadge">‚Äî</div>
        </div>
        <div class="recipe" id="recipe">Tap ‚ÄúGenerate Recipe‚Äù to create something tasty!</div>
        <div class="btnbar">
          <button id="btnSave">‚≠ê Save Favorite</button>
          <button class="warn" id="btnClearFavs">üóëÔ∏è Clear Favorites</button>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>Favorites</h2>
      <div class="body" id="favs"></div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>How to Spin (Ninja Creami Directions)</h2>
      <div class="body">
        <ol>
          <li>Blend base until fully smooth. Pour into pint to MAX FILL line. Freeze level for 20‚Äì24 hours.</li>
          <li>First spin: <b>Lite Ice Cream</b> (or <b>Ice Cream</b> for higher‚Äëfat bases). If crumbly, <b>Re‚Äëspin</b>.</li>
          <li>If using <b>swirls</b>, create a 1‚Äëinch tunnel and add, then spin on <b>Mix‚ÄëIn</b>.</li>
          <li>If using <b>mix‚Äëins</b> (cookies, chips, etc.), fold into the tunnel and run <b>Mix‚ÄëIn</b> once.</li>
          <li>Taste and adjust sweetness with 1‚Äì2 tsp extra milk & pinches of sweetener; quick <b>Re‚Äëspin</b> if needed.</li>
        </ol>
        <p class="muted small">Tip: For ultra‚Äëcreamy texture with milk bases, 1‚Äì2 g xanthan + a spoon of Greek yogurt can help emulsify without big calories.</p>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <h2>Pantry & Calorie Assumptions</h2>
      <div class="body">
        <div class="rowlist small">
          <div class="code" id="pantryCode"></div>
          <div class="muted">You can edit the pantry via the <b>üõ†Ô∏è Edit pantry</b> button. Numbers are ballpark‚Äîbrand calories vary.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Pantry editor modal -->
  <div class="modal" id="pantryModal" aria-hidden="true">
    <div class="panel">
      <header class="wrap"><h2 style="margin:0">Edit Pantry</h2><div class="sub">Toggle items or paste custom JSON. Your changes are saved locally.</div></header>
      <div class="body">
        <div class="btnbar">
          <button class="ghost" id="btnLoadDefaults">Restore defaults</button>
          <button class="ghost" id="btnExport">Export pantry JSON</button>
        </div>
        <label>JSON editor</label>
        <textarea id="pantryTextarea" class="json" spellcheck="false"></textarea>
        <div class="small muted" style="margin-top:8px">Tip: You can remove an ingredient by deleting its object or add new ones following the same structure. Themes: chocolate, cookie, caramel, mocha, pb, vanilla, fruity, malty.</div>
      </div>
      <footer>
        <button class="ghost" id="btnClosePantry">Cancel</button>
        <button class="primary" id="btnApplyPantry">Apply changes</button>
      </footer>
    </div>
  </div>

  <!-- Add-to-Home-Screen tip (only shows when not installed/standalone) -->
  <div id="installTip">
    <div class="row">
      <div>
        <b>Install to Home Screen</b><br>
        Open in Safari ‚Üí Share ‚Üí <b>Add to Home Screen</b>. Then launch from the icon for the full‚Äëscreen app.
      </div>
      <div><button class="ghost" id="dismissTip">Got it</button></div>
    </div>
  </div>

  <div class="footer wrap">Built for your stash: milk bases, Greek yogurt, monk fruit, xanthan, cocoa (regular & black), malt, cookie butter, chocolate hazelnut, caramel, vanilla, biscoff, PB powder, Jell‚ÄëO puddings (butterscotch, white chocolate, cheesecake), protein powders, water enhancers, diet sodas, coffee/K‚Äëcup, optional brown sugar. No cake‚Äëbatter by default.</div>

<script>
// --- PWA: create a service worker from a Blob so this stays one-file --------
(function(){
  if(!('serviceWorker' in navigator)) return;
  const swCode = `
    const CACHE = 'creami-cache-v1';
    self.addEventListener('install', e=>{
      e.waitUntil((async()=>{ const c = await caches.open(CACHE); await c.addAll([ self.registration.scope ]); })());
      self.skipWaiting();
    });
    self.addEventListener('activate', e=>{ self.clients.claim(); });
    self.addEventListener('fetch', e=>{
      const req = e.request; const url = new URL(req.url);
      if(url.origin === self.location.origin){
        e.respondWith((async()=>{ const c = await caches.open(CACHE); const cached = await c.match(req); if(cached) return cached; const res = await fetch(req); if(req.method==='GET' && res.ok){ c.put(req, res.clone()); } return res; })());
      }
    });`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(console.error);
})();

// --- Detect standalone mode & show install tip -----------------------------
(function(){
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  const tip = document.getElementById('installTip');
  const dismissed = localStorage.getItem('creami_tip_dismissed');
  if(!isStandalone && !dismissed){ tip.style.display='block'; }
  document.getElementById('dismissTip').onclick = ()=>{ tip.style.display='none'; localStorage.setItem('creami_tip_dismissed','1'); };
})();

// --- Pantry defaults + persistence ----------------------------------------
const PANTRY_KEY = 'creami_pantry_v1';
const defaultPantry = {
  bases: [
    { key:'vanilla_milk', label:'Vanilla milk base', kcal: 90, unit:'per 240ml', note:'low‚Äëfat dairy or Fairlife‚Äëstyle' },
    { key:'chocolate_milk', label:'Chocolate milk base', kcal: 120, unit:'per 240ml' },
    { key:'greek_yogurt', label:'Greek yogurt (2‚Äì4 tbsp)', kcal: 40, unit:'per 40g', note:'adds body' },
    { key:'protein_powder', label:'Whey/casein protein (1 scoop)', kcal: 120, unit:'per scoop', note:'optional' }
  ],
  structure: [
    { key:'xanthan', label:'Xanthan gum (1‚Äì2 g)', kcal: 5 },
    { key:'salt', label:'Pinch of salt', kcal: 0 }
  ],
  sweeteners: [
    { key:'monkfruit', label:'Monk fruit/erythritol', kcal: 0 },
    { key:'brown_sugar', label:'Brown sugar (1‚Äì2 tsp, optional)', kcal: 30 }
  ],
  extracts: [
    { key:'vanilla_ext', label:'Vanilla extract', theme:['vanilla','cookie','caramel','fruity','coffee'] },
    { key:'butter_ext', label:'Butter extract', theme:['cookie','caramel'] },
    { key:'cookie_butter_ext', label:'Cookie butter extract', theme:['cookie','caramel'] },
    { key:'choc_haz_ext', label:'Chocolate hazelnut extract', theme:['chocolate','mocha'] },
    { key:'caramel_ext', label:'Caramel extract', theme:['caramel','mocha'] },
    { key:'birthday_cake_ext', label:'Birthday cake extract', theme:['cake'] }
  ],
  powders: [
    { key:'cocoa', label:'Cocoa powder (1‚Äì2 tbsp)', kcal: 24, theme:['chocolate','mocha'] },
    { key:'black_cocoa', label:'Black cocoa (1 tbsp)', kcal: 12, theme:['chocolate'] },
    { key:'malt', label:'Malt powder (1‚Äì2 tsp)', kcal: 20, theme:['malty','chocolate','cookie'] },
    { key:'pb_powder', label:'PB powder (2 tbsp)', kcal: 50, theme:['pb','cookie','chocolate'] },
    { key:'instant_coffee', label:'Instant coffee / K‚Äëcup grounds (1‚Äì2 tsp)', kcal: 4, theme:['mocha','coffee'] },
    { key:'protein_choc', label:'Chocolate protein (scoop)', kcal: 120, theme:['chocolate','mocha'] },
    { key:'protein_van', label:'Vanilla protein (scoop)', kcal: 120, theme:['vanilla','cookie','caramel','fruity'] },
    { key:'pud_butterscotch', label:'Butterscotch FF Jell‚ÄëO (1 tbsp)', kcal: 25, theme:['caramel'] },
    { key:'pud_whitechoc', label:'White chocolate FF Jell‚ÄëO (1 tbsp)', kcal: 25, theme:['vanilla','cookie'] },
    { key:'pud_cheesecake', label:'Cheesecake FF Jell‚ÄëO (1 tbsp)', kcal: 25, theme:['cookie','fruity'] },
    { key:'water_enh', label:'Sugar‚Äëfree water enhancer (fruit)', kcal: 0, theme:['fruity'] },
    { key:'diet_soda', label:'Splash of diet soda (fruit/vanilla)', kcal: 0, theme:['fruity','vanilla'] }
  ],
  mixins: [
    { key:'biscoff', label:'Crushed Biscoff (1‚Äì2 cookies)', kcal: 70, theme:['cookie','caramel'] },
    { key:'oreo_thins', label:'Oreo thins (1‚Äì2)', kcal: 70, theme:['cookie','chocolate'] },
    { key:'chips_choc', label:'Mini chocolate chips (1 tbsp)', kcal: 70, theme:['chocolate','cookie'] },
    { key:'cacao_nibs', label:'Cacao nibs (1 tbsp)', kcal: 60, theme:['chocolate'] }
  ],
  swirls: [
    { key:'caramel_sauce', label:'Light caramel swirl (1 tsp)', kcal: 20, theme:['caramel','mocha'] },
    { key:'cookie_butter', label:'Melted cookie butter (1 tsp)', kcal: 35, theme:['cookie','caramel'] },
    { key:'pb_powder_slurry', label:'PB powder slurry (1‚Äì2 tsp + water)', kcal: 25, theme:['pb','cookie','chocolate'] }
  ]
};

function loadPantry(){
  try{ const json = localStorage.getItem(PANTRY_KEY); if(json){ return JSON.parse(json); } }catch(_){ }
  return structuredClone(defaultPantry);
}
function savePantry(p){ localStorage.setItem(PANTRY_KEY, JSON.stringify(p)); }
let pantry = loadPantry();

// --- UI helpers ------------------------------------------------------------
const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));

function chipbar(el, items, multi=false){
  el.innerHTML = items.map((it,i)=>`<span class="chip${i===0&&!multi?' active':''}" data-key="${it.key}">${it.label}</span>`).join('');
  el.addEventListener('click', e=>{
    if(!e.target.classList.contains('chip')) return;
    if(!multi){ qsa('#'+el.id+' .chip').forEach(c=>c.classList.remove('active')); }
    e.target.classList.toggle('active');
  });
}

const THEMES = [
  {key:'chocolate', label:'Chocolatey'},
  {key:'cookie', label:'Cookie/Cookie Butter'},
  {key:'caramel', label:'Caramel/Butterscotch'},
  {key:'mocha', label:'Mocha/Coffee'},
  {key:'pb', label:'Peanut Butter vibes'},
  {key:'vanilla', label:'Classic Vanilla'},
  {key:'fruity', label:'Fruity (yogurt‚Äëfriendly)'},
  {key:'malty', label:'Malted milkshake'}
];

const BASES = [
  {key:'vanilla_milk', label:'Vanilla Milk'},
  {key:'chocolate_milk', label:'Chocolate Milk'},
  {key:'yogurt_mix', label:'Milk + Greek Yogurt'},
  {key:'protein_milk', label:'Milk + Protein'}
];

chipbar(qs('#baseChips'), BASES);
chipbar(qs('#themeChips'), THEMES, true);

// --- RNG (seedable) --------------------------------------------------------
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++)h=Math.imul(h^str.charCodeAt(i),3432918353),h=h<<13|h>>>19;return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0}}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296;}}
function rngFactory(seed){ if(!seed) return Math.random; const s=xmur3(seed)(); return mulberry32(s); }

function pick(arr, rng){ return arr[Math.floor(rng()*arr.length)] }
function pickSome(arr, n, rng){ const copy=[...arr]; const out=[]; while(copy.length && out.length<n){ out.push(copy.splice(Math.floor(rng()*copy.length),1)[0]); } return out; }

// --- Logic -----------------------------------------------------------------
function filterTheme(list, themes){ return list.filter(x=>!x.theme || x.theme.some(t=>themes.includes(t))); }
function estimateKcal(parts){ return Math.round(parts.reduce((s,p)=> s + (p.kcal||0), 0)/5)*5; }
function activeThemes(){ const t = qsa('#themeChips .chip.active').map(c=>c.dataset.key); return t.length? t : ['vanilla']; }
function activeBase(){ const el = qs('#baseChips .chip.active'); return el? el.dataset.key : 'vanilla_milk'; }

function genRecipe(){
  const seed = qs('#seed').value.trim();
  const rng = rngFactory(seed || String(Date.now()));
  const themes = activeThemes();
  const milkOnly = qs('#milkOnly').checked;
  const excludeCake = qs('#excludeCake').checked;
  const sweet = Number(qs('#sweetSlider').value);
  const intense = Number(qs('#intenseSlider').value);
  const maxMix = Number(qs('#mixMax').value);
  const maxSwirl = Number(qs('#swirlMax').value);
  const baseSel = activeBase();

  let extracts = filterTheme(pantry.extracts, themes);
  if(excludeCake) extracts = extracts.filter(x=>x.key!=='birthday_cake_ext');
  let powders = filterTheme(pantry.powders, themes);
  let mixins = filterTheme(pantry.mixins, themes);
  let swirls = filterTheme(pantry.swirls, themes);

  const parts = [];
  if(baseSel==='vanilla_milk') { parts.push(pantry.bases[0]); }
  if(baseSel==='chocolate_milk') { parts.push(pantry.bases[1]); }
  if(baseSel==='yogurt_mix') { parts.push(pantry.bases[0], pantry.bases[2]); }
  if(baseSel==='protein_milk') { parts.push(pantry.bases[0], (themes.includes('chocolate')||themes.includes('mocha'))? pantry.powders.find(p=>p.key==='protein_choc') : pantry.powders.find(p=>p.key==='protein_van')); }

  parts.push({label:'Xanthan gum (1‚Äì2 g)', kcal:5});
  parts.push({label:'Pinch of salt', kcal:0});

  if(sweet>0){ parts.push({label:`Monk fruit to taste (${sweet}/6)`, kcal:0}); }
  if(!milkOnly && Math.random()<0.25 && sweet>=4){ parts.push({label:'(Optional) 1‚Äì2 tsp brown sugar', kcal:30}); }

  const powCount = Math.max(1, Math.min(3, Math.round(intense/2 + (themes.includes('mocha')||themes.includes('chocolate')?1:0))));
  const extCount = Math.max(1, Math.min(2, Math.round(intense/3 + 1)));
  const selPow = pickSome(powders, Math.min(powCount, powders.length), rng);
  const selExt = pickSome(extracts, Math.min(extCount, extracts.length), rng);
  selPow.forEach(p=>parts.push(p)); selExt.forEach(e=>parts.push(e));

  const selMix = pickSome(mixins, Math.min(maxMix, mixins.length), rng);
  const selSwirl = pickSome(swirls, Math.min(maxSwirl, swirls.length), rng);

  const themeLabel = themes.map(t=>THEMES.find(x=>x.key===t)?.label||t).join(' + ');
  const title = `${pick(['Dream','Vibe','Cloud','Rush','Whirl','Twist','Scoop','Storm','Glow','Crush'], rng)} ${pick(['Blend','Cream','Swirl','Mash','Magic','Fusion','Craze'], rng)} ‚Äî ${themeLabel}`;

  const baseHow = milkOnly? `Base: 240‚Äì300 ml milk of choice` :
    baseSel==='yogurt_mix'? `Base: 220‚Äì260 ml milk + 2‚Äì4 tbsp Greek yogurt` :
    baseSel==='protein_milk'? `Base: 240 ml milk + 1 scoop protein` :
    (baseSel==='chocolate_milk'? `Base: 240‚Äì300 ml chocolate milk` : `Base: 240‚Äì300 ml milk`);

  function list(parts){ return parts.map(p=>`‚Ä¢ ${p.label || p}`).join('\n'); }

  const body = [
    `# ${title}`,
    `\nTheme: ${themeLabel}`,
    `\n${baseHow}`,
    `‚Ä¢ Xanthan gum (1‚Äì2 g)\n‚Ä¢ Pinch of salt`,
    (sweet>0? `‚Ä¢ Monk fruit sweetener to taste (${sweet}/6)` : ''),
    (parts.find(p=>p.label && p.label.startsWith('(Optional) 1‚Äì2 tsp brown sugar'))? '‚Ä¢ (Optional) 1‚Äì2 tsp brown sugar for depth' : ''),
    `\nFlavor builders:`,
    list(selPow.concat(selExt)),
    selMix.length? `\nMix‚Äëins (after first spin):\n${list(selMix)}` : '',
    selSwirl.length? `\nSwirl (after first spin, tunnel method):\n${list(selSwirl)}` : '',
    `\nMethod:`,
    `1) Blend base + structure + flavor builders until smooth. Pour to MAX FILL. Freeze 20‚Äì24 h level.`,
    `2) Spin on Lite Ice Cream ‚Üí Re‚Äëspin if needed.`,
    selMix.length || selSwirl.length ? `3) Add mix‚Äëins/swirl in a tunnel ‚Üí Mix‚ÄëIn once.` : `3) Adjust sweetness if needed and enjoy.`,
    `\nPro tips: pinch of salt boosts chocolate/caramel; black cocoa for Oreo vibes; malt for old‚Äëschool shake energy.`
  ].filter(Boolean).join('\n');

  const kcal = estimateKcal([ ...parts, ...selMix, ...selSwirl ]);
  return { title, text: body, kcal, theme: themeLabel, state:{selPow, selExt, selMix, selSwirl, seed, themes, baseSel, milkOnly, sweet, intense} };
}

let current = null;

function render(r){
  current = r;
  qs('#recipe').textContent = r.text;
  qs('#calories').textContent = `~${r.kcal} kcal / pint (est.)`;
  qs('#themeBadge').textContent = r.theme || '‚Äî';
}

qs('#btnGenerate').addEventListener('click', ()=>{ render(genRecipe()); });
qs('#btnRerollMix').addEventListener('click', ()=>{
  if(!current) return; 
  const seed = current.state.seed || String(Date.now());
  const rng = rngFactory(seed+'mix');
  const themes = current.state.themes;
  const mixins = filterTheme(pantry.mixins, themes);
  const swirls = filterTheme(pantry.swirls, themes);
  const selMix = pickSome(mixins, Math.min(Number(qs('#mixMax').value), mixins.length), rng);
  const selSwirl = pickSome(swirls, Math.min(Number(qs('#swirlMax').value), swirls.length), rng);
  const kcal = estimateKcal([ ...current.state.selPow, ...current.state.selExt, ...selMix, ...selSwirl ]);
  current.state.selMix = selMix; current.state.selSwirl = selSwirl;
  function replaceSection(text, header, replacement){ const re = new RegExp(header+"[\\s\\S]*?(?=\\n\\n|$)", 'i'); return replacement ? text.replace(re, replacement) : text.replace(re, ''); }
  let newText = current.text;
  newText = replaceSection(newText, 'Mix‚Äëins', selMix.length? `Mix‚Äëins (after first spin):\n${selMix.map(p=>`‚Ä¢ ${p.label}`).join('\n')}` : '');
  newText = replaceSection(newText, 'Swirl', selSwirl.length? `Swirl (after first spin, tunnel method):\n${selSwirl.map(p=>`‚Ä¢ ${p.label}`).join('\n')}` : '');
  current.text = newText; current.kcal = kcal; render(current);
});

qs('#btnRerollFlavor').addEventListener('click', ()=>{ if(!current) return; render(genRecipe()); });
qs('#btnCopy').addEventListener('click', async ()=>{ if(!current) return; await navigator.clipboard.writeText(current.text); const b=qs('#btnCopy'); b.textContent='‚úÖ Copied'; setTimeout(()=>b.textContent='üìã Copy',1200); });

// Favorites
function loadFavs(){ return JSON.parse(localStorage.getItem('creami_favs')||'[]'); }
function saveFavs(list){ localStorage.setItem('creami_favs', JSON.stringify(list)); }
function renderFavs(){
  const list = loadFavs();
  const c = qs('#favs');
  if(!list.length){ c.innerHTML = '<span class="muted">No favorites yet.</span>'; return; }
  c.innerHTML = list.map((r,i)=>`
    <div class="card" style="border-radius:10px;border:1px solid #232744; padding:12px; margin-bottom:10px">
      <div class="fav">
        <div>
          <div style="font-weight:700">${r.title}</div>
          <div class="small muted">~${r.kcal} kcal ‚Ä¢ ${r.theme}</div>
        </div>
        <div class="btnbar">
          <button data-i="${i}" class="ghost copyFav">Copy</button>
          <button data-i="${i}" class="warn delFav">Delete</button>
        </div>
      </div>
      <pre class="recipe" style="margin-top:10px">${r.text}</pre>
    </div>
  `).join('');
  c.querySelectorAll('.delFav').forEach(b=>b.addEventListener('click', e=>{ const i=Number(e.target.dataset.i); const l=loadFavs(); l.splice(i,1); saveFavs(l); renderFavs(); }));
  c.querySelectorAll('.copyFav').forEach(b=>b.addEventListener('click', async e=>{ const i=Number(e.target.dataset.i); const l=loadFavs(); await navigator.clipboard.writeText(l[i].text); e.target.textContent='‚úÖ Copied'; setTimeout(()=>e.target.textContent='Copy',1200); }));
}
qs('#btnSave').addEventListener('click', ()=>{ if(!current) return; const l=loadFavs(); l.unshift(current); saveFavs(l.slice(0,50)); renderFavs(); });
qs('#btnClearFavs').addEventListener('click', ()=>{ if(confirm('Clear all favorites?')){ saveFavs([]); renderFavs(); }});
renderFavs();

// Pantry display + editor wiring
function refreshPantryCode(){ qs('#pantryCode').textContent = JSON.stringify(pantry, null, 2); }
refreshPantryCode();
qs('#btnPantry').addEventListener('click', ()=>{ const m=qs('#pantryModal'); qs('#pantryTextarea').value = JSON.stringify(pantry, null, 2); m.style.display='grid'; m.setAttribute('aria-hidden','false'); });
qs('#btnClosePantry').addEventListener('click', ()=>{ const m=qs('#pantryModal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); });
qs('#btnLoadDefaults').addEventListener('click', ()=>{ qs('#pantryTextarea').value = JSON.stringify(defaultPantry, null, 2); });
qs('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(pantry, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'creami-pantry.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
qs('#btnApplyPantry').addEventListener('click', ()=>{
  try{
    const parsed = JSON.parse(qs('#pantryTextarea').value);
    // rudimentary sanity check
    if(!parsed || !parsed.bases || !parsed.powders) throw new Error('Pantry JSON missing required sections.');
    pantry = parsed; savePantry(pantry); refreshPantryCode(); alert('Pantry updated! New flavors will use your changes.');
    qs('#pantryModal').style.display='none'; qs('#pantryModal').setAttribute('aria-hidden','true');
  }catch(err){ alert('Invalid JSON: '+ err.message); }
});
</script>
</body>
</html>
